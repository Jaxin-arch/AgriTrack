<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2E7D32">
<title>AgriTrack - Monitoring Crop Demand & Supply in Maragusan</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
[class^="ri-"]::before, [class*=" ri-"]::before {
  font-family: remixicon !important;
  font-style: normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f8f9fa;
}

/* Section handling */
.section {
  display: none;
}
.section.active {
  display: block;
}

/* Floating menu styles */
.floating-menu {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 1000;
}
.menu-button {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #2E7D32;
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}
.menu-button:hover {
  background: linear-gradient(to bottom, #2E7D32, 
  rgba(46, 110, 50, 0.8));
  transform: scale(1.05);
}
.hamburger-line {
  width: 24px;
  height: 2px;
  background-color: white;
  margin: 3px 0;
  transition: all 0.3s ease;
}
.menu-button.active .hamburger-line:nth-child(1) {
  transform: translateY(8px) rotate(45deg);
}
.menu-button.active .hamburger-line:nth-child(2) {
  opacity: 0;
}
.menu-button.active .hamburger-line:nth-child(3) {
  transform: translateY(-8px) rotate(-45deg);
}
.menu-content {
  position: absolute;
  bottom: 70px;
  right: 0;
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  width: 200px;
  overflow: hidden;
  transform: scale(0.9);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  transform-origin: bottom right;
}
.menu-content.show {
  transform: scale(1);
  opacity: 1;
  visibility: visible;
}
.menu-item {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  color: #333;
  text-decoration: none;
  transition: all 0.2s ease;
}
.menu-item:hover {
  background-color: #f5f5f5;
  color: #2E7D32;
}
.menu-item i {
  margin-right: 10px;
  font-size: 1.1rem;
}
.menu-divider {
  height: 1px;
  background-color: #e0e0e0;
  margin: 4px 0;
}

/* Map Section Styles */
#map-section {
  position: relative;
  height: 100vh;
  width: 100%;
  overflow: hidden;
}

#maragusanMap {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}

.map-controls {
  position: absolute;
  top: 65px;
  left: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(5px);
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: fixed;
}

#barangaySelector {
  flex: 1;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-right: 8px;
}

#resetMap {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  color: #2E7D32;
}

#resetMap:hover {
  background: #f0f0f0;
}

.map-overlay {
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(5px);
  border-radius: 8px;
  padding: 12px;
  width: 250px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: none;
}

.map-overlay.active {
  display: block;
}

.map-overlay h3 {
  font-size: 1rem;
  margin-bottom: 8px;
  color: #333;
}

.map-overlay-close {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
}

#cropPieChart {
  height: 160px;
  width: 100%;
}

.crop-legend {
  font-size: 0.7rem;
  margin-top: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}

.crop-legend-item {
  display: flex;
  align-items: center;
}

.crop-legend-color {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 4px;
}

/* Leaflet styles */
.leaflet-control {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  overflow: hidden;
}

.leaflet-popup-content-wrapper {
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

/* Home section styles */
.rounded-button {
  border-radius: 8px;
}

.bg-green-gradient {
    background: linear-gradient(to bottom, #2E7D32, rgba(46, 125, 50, 0.8));
  }
  
  #barangayInfoPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 15px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  z-index: 1000;
}

#barangayInfoPanel.active {
  transform: translateY(0);
}

#barangayInfoPanel h3 {
  margin-top: 0;
  color: #2E7D32;
}

.crop-legend-item {
  display: flex;
  align-items: center;
  margin: 5px 0;
}

.crop-legend-color {
  display: inline-block;
  width: 15px;
  height: 15px;
  margin-right: 10px;
  border-radius: 3px;
}

/* Slide Panel Styles */
#slidePanel {
  position: fixed;
  bottom: -450px;
  left: 0;
  right: 0;
  height: 450px;
  background: white;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
  transition: transform 0.3s ease-in-out;
  z-index: 1000;
  padding: 15px;
  /* Remove overflow-y from here */
}

#slidePanel.open {
  transform: translateY(-450px); /* Changed to -450px to match height */
}

#slidePanelHandle {
  width: 50px;
  height: 5px;
  background: #ccc;
  border-radius: 5px;
  margin: 0 auto 15px;
  cursor: pointer;
  /* Prevent handle from interfering with scrolling */
  touch-action: none;
}

#slidePanelContent {
  height: calc(100% - 30px); /* Adjust if needed */
  overflow-y: auto;
  /* Improve scrolling behavior */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  overscroll-behavior: contain; /* Prevent scroll chaining */
  /* Optional: add padding if content looks cramped */
  padding: 5px;
}
/* Barangay Info Styles */
.barangay-info {
  margin-bottom: 15px;
}

.barangay-stats {
  display: flex;
  justify-content: space-between;
  margin: 15px 0;
}

.stat-item {
  text-align: center;
  flex: 1;
}

.stat-value {
  font-size: 18px;
  font-weight: bold;
  color: #2E7D32;
}

.stat-label {
  font-size: 12px;
  color: #666;
}

/* Chart Container */
.chart-container {
  height: 200px;
  margin: 15px 0;
}

/* Crop Legend */
#cropLegend {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
}

.crop-legend-item {
  display: flex;
  align-items: center;
  font-size: 12px;
}

.crop-legend-color {
  width: 12px;
  height: 12px;
  border-radius: 3px;
  margin-right: 5px;
  display: inline-block;
}

/* Add this to your existing CSS */
#barangayTitle {
  cursor: pointer;
  user-select: none; /* Prevents text selection when clicking */
}
</style>
</head>
<body class="bg-white">
<!-- Navigation Bar -->
<nav class="bg-green-gradient text-white fixed top-0 w-full z-50 shadow-md">
  <div class="flex items-center justify-between px-4 py-3">
    <div class="font-['Pacifico'] text-2xl tracking-wide">AgriTrack</div>
  </div>
</nav>

<!-- Floating Hamburger Menu -->
<div class="floating-menu">
  <div class="menu-button" id="menuButton">
    <div class="hamburger-line"></div>
    <div class="hamburger-line"></div>
    <div class="hamburger-line"></div>
  </div>
  
  <div class="menu-content" id="menuContent">
    <a href="#" class="menu-item active" data-section="home-section">
      <i class="ri-home-line"></i> Home
    </a>
    <a href="#" class="menu-item" data-section="map-section">
      <i class="ri-map-pin-line"></i> Agricultural Map
    </a>
    <a href="#" class="menu-item" data-section="other-section">
      <i class="ri-price-tag-3-line"></i> Market Prices
    </a>
    <div class="menu-divider"></div>
    <a href="jey.html" class="menu-item">
      <i class="ri-add-circle-line"></i> Add Farm Data
    </a>
  </div>
</div>

<!-- Main Content Area -->
<main class="pt-16 px-4">
  <!-- Home Section (Active by default) -->
  <section id="home-section" class="section active">
    <section class="mt-4 mb-8">
      <div class="relative rounded-lg overflow-hidden h-48 mb-4">
        <img src="https://images.unsplash.com/photo-1605000797499-95a51c5269ae?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80" alt="Agricultural Landscape" class="w-full h-full object-cover object-top">
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex flex-col justify-end p-4">
          <h1 class="text-white text-2xl font-bold">Monitor Crop Demand & Supply</h1>
          <p class="text-white text-sm mt-1">Real-time agricultural data for Maragusan farmers</p>
        </div>
      </div>
    </section>

    <section class="bg-white rounded-lg shadow-md p-5 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800 padding-30">
          Top Crops in Maragusan</h2>
      </div>
      <div class="space-y-4" id="cropsContainer">
        <!-- Dynamic content will be loaded here -->
      </div>
    </section>
  </section>

<!-- Map Section -->
<section id="map-section" class="section">
  <div class="relative h-screen">
    <!-- Map container -->
    <div id="maragusanMap" class="absolute inset-0 z-0"></div>
    
    <!-- Map controls at top -->
    <div class="map-controls">
<select id="barangaySelector">
          <option value="" disabled selected>Select Barangay</option>
          <option value="Bagong Silang">Bagong Silang</option>
          <option value="Bahi">Bahi</option>
          <option value="Cambagang">Cambagang</option>
          <option value="Coronobe">Coronobe</option>
          <option value="Katipunan">Katipunan</option>
          <option value="Langgawisan">Langgawisan</option>
          <option value="Lahi">Lahi</option>
          <option id="Mabugnao-btn" value="Mabugnao">Mabugnao</option>
          <option value="Magcagong">Magcagong</option>
          <option value="Mahayahay">Mahayahay</option>
          <option value="Mapawa">Mapawa</option>
          <option value="Maragusan">Poblacion</option>
          <option value="Mauswagon">Mauswagon</option>
          <option value="New Albay">New Albay</option>
          <option value="New Katipunan">New Katipunan</option>
          <option value="New Manay">New Manay</option>
          <option value="New Panay">New Panay</option>
          <option value="Paloc">Paloc</option>
          <option value="Pamintaran">Pamintaran</option>
          <option value="Parasanon">Parasanon</option>
          <option value="Talian">Talian</option>
          <option value="Tandik">Tandik</option>
          <option value="Tigbao">Tigbao</option>
          <option value="Tupas">Tupas</option>
        </select>
      <button id="resetMap" title="Reset view">
        <i class="ri-refresh-line"></i>
      </button>
    </div>
    
    <!-- Slide Panel (should be only one) -->
    <div id="slidePanel">
      <div id="slidePanelHandle"></div>
      <div id="slidePanelContent">
        <h3 id="barangayTitle">Select a Barangay</h3>
        <div class="barangay-stats">
          <div class="stat-item">
            <div class="stat-value" id="barangayArea">--</div>
            <div class="stat-label">Area</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="barangayPopulation">--</div>
            <div class="stat-label">Population</div>
          </div>
        </div>
        <div class="chart-container">
          <div id="cropPieChart" style="width:100%;height:100%;"></div>
        </div>
        <div id="cropLegend"></div>
      </div>
    </div>
  </div>
</section>
  <!-- Market Analytics Section (Hidden by default) -->
  <section id="other-section" class="section">
    <div class="bg-white rounded-lg shadow-md p-5 mb-8">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-3">
        <h2 class="text-xl font-semibold text-gray-800">Market Analytics</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <div class="relative flex-1">
            <select id="priceCropFilter" class="w-full text-sm border border-gray-300 rounded-button py-2 pl-3 pr-8 appearance-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="pechay">Pechay</option>
<option value="chinese_cabbage">Chinese Cabbage</option>
<option value="lettuce">Lettuce</option>
<option value="carrots">Carrots</option>
<option value="bell_pepper">Bell Pepper</option>
<option value="chili_pepper">Chili Pepper</option>
<option value="string_beans">String Beans</option>
<option value="okra">Okra</option>
<option value="eggplant">Eggplant</option>
<option value="ampalaya">Ampalaya (Bitter Melon)</option>
<option value="squash">Squash</option>
<option value="cucumber">Cucumber</option>
<option value="tomato">Tomato</option>
<option value="sweet_potato">Sweet Potato (Camote)</option>
<option value="gabi">Gabi (Taro)</option>
<option value="kangkong">Kangkong (Water Spinach)</option>
<option value="banana_saba">Banana (Saba)</option>
<option value="banana_lakatan">Banana (Lakatan)</option>
<option value="papaya">Papaya</option>
<option value="pineapple">Pineapple</option>
<option value="mango">Mango</option>
<option value="calamansi">Calamansi</option>
<option value="coconut">Coconut</option>
<option value="durian">Durian</option>
<option value="rambutan">Rambutan</option>
<option value="lanzones">Lanzones</option>
<option value="jackfruit">Jackfruit</option>
<option value="rice">Rice (Palay)</option>
<option value="corn">Corn (Maize)</option>
<option value="cassava">Cassava</option>
<option value="coffee">Coffee</option>
<option value="cacao">Cacao</option>
<option value="abaca">Abaca</option>
            </select>
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
              <i class="ri-arrow-down-s-line"></i>
            </div>
          </div>
        </div>
      </div>
      <div id="otherCropsChart" style="height: 200px;" class="mb-4"></div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Farm Gate (₱)</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Retail (₱)</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Demand</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
            </tr>
          </thead>
          <tbody id="priceTableBody" class="bg-white divide-y divide-gray-100">
            <!-- Dynamic content will be loaded here -->
          </tbody>
        </table>
      </div>
      <div class="mt-3 flex flex-col sm:flex-row justify-between items-center text-xs text-gray-500">
        <div class="mb-2 sm:mb-0">
          <i class="ri-information-line mr-1"></i> Prices are average estimates based on local trader reports
        </div>
        <div>
          <i class="ri-time-line mr-1"></i> Updated: <span id="priceUpdateDate">April 22, 2025</span>
        </div>
      </div>
    </div>
  </section>
</main>  

<script>
  // Application state for real data
  let approvedFarms = [];
  let cropStatistics = {};
  let marketPrices = [];
  let supabase = null;
  

  // All available crops from your list
const ALL_CROPS = [
    'banana', 'durian', 'coconut', 'mango', 'pineapple', 'papaya', 'watermelon',
    'rice', 'corn', 'cabbage', 'pechay', 'kangkong', 'spinach', 'tomato',
    'eggplant', 'bell pepper', 'ampalaya', 'sayote', 'squash', 'okra',
    'baguio beans', 'string_beans', 'mung bean', 'peanut', 'carrots', 'radish',
    'sweet potato', 'cassava', 'ginger', 'garlic', 'onion', 'coffee', 'cacao',
    'abaca', 'rubber', 'sugarcane'
];
 // Add this function after your ALL_CROPS array
function normalizeBarangayNameForData(barangayName) {
    return barangayName.toLowerCase().trim();
} 

  function debugBarangayData() {
    console.log('🗺️ DEBUG: Real barangay data:', window.realBarangayData);
    
    if (window.realBarangayData) {
        Object.entries(window.realBarangayData).forEach(([barangay, data]) => {
            console.log(`🗺️ ${barangay}:`, data);
        });
    }
}
  // Crop images mapping
  const CROP_IMAGES = {
    'banana': 'https://cdn-icons-png.flaticon.com/512/2909/2909761.png',
    'durian': 'https://cdn-icons-png.flaticon.com/512/6866/6866583.png',
    'coconut': 'https://cdn-icons-png.flaticon.com/512/3944/3944201.png',
    'mango': 'https://cdn-icons-png.flaticon.com/512/2909/2909797.png',
    'pineapple': 'https://cdn-icons-png.flaticon.com/512/6866/6866518.png',
    'papaya': 'https://cdn-icons-png.flaticon.com/512/6866/6866557.png',
    'watermelon': 'https://cdn-icons-png.flaticon.com/512/6166/6166890.png',
    'rice': 'https://cdn-icons-png.flaticon.com/512/6835/6835694.png',
    'corn': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'cabbage': 'https://cdn-icons-png.flaticon.com/512/11453/11453869.png',
    'pechay': 'https://cdn-icons-png.flaticon.com/512/11453/11453869.png',
    'kangkong': 'https://cdn-icons-png.flaticon.com/512/11453/11453869.png',
    'spinach': 'https://cdn-icons-png.flaticon.com/512/11453/11453869.png',
    'tomato': 'https://cdn-icons-png.flaticon.com/512/8645/8645342.png',
    'eggplant': 'https://cdn-icons-png.flaticon.com/512/6409/6409599.png',
    'bell pepper': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'ampalaya': 'https://cdn-icons-png.flaticon.com/512/2158/2158598.png',
    'sayote': 'https://cdn-icons-png.flaticon.com/512/2158/2158598.png',
    'squash': 'https://cdn-icons-png.flaticon.com/512/6490/6490234.png',
    'okra': 'https://cdn-icons-png.flaticon.com/512/7217/7217794.png',
    'baguio beans': 'https://cdn-icons-png.flaticon.com/512/6835/6835694.png',
    'string_beans': 'https://cdn-icons-png.flaticon.com/512/16442/16442794.png',
    'mung bean': 'https://cdn-icons-png.flaticon.com/512/6835/6835694.png',
    'peanut': 'https://cdn-icons-png.flaticon.com/512/6835/6835694.png',
    'carrots': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'radish': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'sweet potato': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'cassava': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'ginger': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'garlic': 'https://cdn-icons-png.flaticon.com/512/3079/3079537.png',
    'onion': 'https://cdn-icons-png.flaticon.com/512/2522/2522907.png',
    'coffee': 'https://cdn-icons-png.flaticon.com/512/3082/3082675.png',
    'cacao': 'https://cdn-icons-png.flaticon.com/512/6176/6176920.png',
    'abaca': 'https://cdn-icons-png.flaticon.com/512/2158/2158598.png',
    'rubber': 'https://cdn-icons-png.flaticon.com/512/2158/2158598.png',
    'sugarcane': 'https://cdn-icons-png.flaticon.com/512/2158/2158598.png'
  };

  // Initialize application
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 AgriTrack Main Page Initializing...');
    
    // Initialize Supabase Client
    const supabaseUrl = 'https://mqmlffykchrviajwvykj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xbWxmZnlrY2hydmlhand2eWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNjM5MTUsImV4cCI6MjA2ODYzOTkxNX0.Dlh4e_dALkEbzZz3hDbiyLb11rMPR0KQPQfHFJx_WmE';
    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    console.log('✅ Supabase initialized');
    
    // Set first menu item as active
    document.querySelectorAll('.menu-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector('.menu-item[data-section="home-section"]').classList.add('active');
    
    // Initialize the map when map section is accessed
    let mapInitialized = false;
    
    const mapMenuItem = document.querySelector('.menu-item[data-section="map-section"]');
    if (mapMenuItem) {
      mapMenuItem.addEventListener('click', function() {
        if (!mapInitialized) {
          initAgriculturalMap();
          mapInitialized = true;
        }
      });
    }
// Add this debug function and call it after updateBarangayCropData

    
    // Load initial data
loadApprovedFarmsData();
debugDataLoading(); // Add this line
loadMarketPricesData();

// Add this debug function
async function debugDataLoading() {
    console.log('🔍 DEBUG: Checking data loading...');
    
    if (!supabase) {
        console.log('❌ Supabase not initialized');
        return;
    }

    try {
        // Test direct Supabase query
        const { data: testFarms, error } = await supabase
            .from('farms')
            .select('id, farm_status, crops(crop_type)')
            .eq('farm_status', 'approved')
            .limit(5);

        console.log('🔍 DEBUG: Direct farms query result:', testFarms);
        console.log('🔍 DEBUG: Query error:', error);
        console.log('🔍 DEBUG: Number of approved farms:', testFarms?.length);

        if (testFarms && testFarms.length > 0) {
            console.log('🔍 DEBUG: Sample farm data:', testFarms[0]);
        }

    } catch (error) {
        console.log('🔍 DEBUG: Error in test query:', error);
    }
}
  });

  // ============================================================================
  // REAL DATA FUNCTIONS - SUPABASE INTEGRATION
  // ============================================================================

  // Load REAL approved farms data from Supabase
  async function loadApprovedFarmsData() {
    console.log('🔍 DEBUG: Starting loadApprovedFarmsData');
    
    if (!supabase) {
        console.log('❌ DEBUG: Supabase not initialized yet');
        updateTopCropsUI([]);
        return;
    }

    try {
        console.log('🔍 DEBUG: Querying Supabase for approved farms...');
        
        const { data: farms, error } = await supabase
            .from('farms')
            .select(`
                id,
                land_area,
                area_unit,
                farm_status,
                verified_at,
                created_at,
                farmers!farmer_id (
                    id,
                    full_name,
                    barangay
                ),
                crops(*)
            `)
            .eq('farm_status', 'approved')
            .order('verified_at', { ascending: false });

        console.log('🔍 DEBUG: Supabase query result - farms:', farms);
        console.log('🔍 DEBUG: Supabase query error:', error);
        console.log('🔍 DEBUG: Number of approved farms found:', farms?.length);

        if (error) {
            console.error('❌ DEBUG: Error fetching approved farms:', error);
            updateTopCropsUI([]);
            return;
        }

        console.log('🔍 DEBUG: Setting approvedFarms to:', farms);
        approvedFarms = farms || [];

        if (approvedFarms.length > 0) {
    console.log('🔍 DEBUG: Processing crop data...');
    cropStatistics = processCropData(approvedFarms);
    console.log('🔍 DEBUG: cropStatistics after processing:', cropStatistics);
    updateTopCropsUI(cropStatistics);
    updateBarangayCropData(approvedFarms);
    debugBarangayData(); // ADD THIS LINE
} else {
            console.log('🔍 DEBUG: No approved farms found');
            updateTopCropsUI([]);
        }
        
    } catch (error) {
        console.error('❌ DEBUG: Error loading approved farms:', error);
        updateTopCropsUI([]);
    }
}
  // Process real farm data into crop statistics
  function processCropData(farms) {
    console.log('🔍 DEBUG: processCropData received farms:', farms);
    console.log('🔍 DEBUG: Number of farms:', farms?.length);
    
    // NEW: Log all unique crop types found in the database
    const allCropsFound = new Set();
    farms.forEach(farm => {
        if (farm.crops && farm.crops.length > 0) {
            farm.crops.forEach(crop => {
                allCropsFound.add(crop.crop_type);
            });
        }
    });
    console.log('🔍 DEBUG: All crop types found in database:', Array.from(allCropsFound));
    console.log('🔍 DEBUG: Our ALL_CROPS list:', ALL_CROPS);
    
    const cropStats = {};
    
    farms.forEach(farm => {
        if (farm.crops && farm.crops.length > 0) {
            farm.crops.forEach(crop => {
    const cropType = crop.crop_type || 'Unknown';
    
    console.log('🔍 DEBUG: Checking crop:', cropType, 'in ALL_CROPS?', ALL_CROPS.includes(cropType));
    
    // Only process crops from our defined list
    if (!ALL_CROPS.includes(cropType)) {
        console.log('🔍 DEBUG: Skipping crop:', cropType);
        return;
    }
                
                if (!cropStats[cropType]) {
                    cropStats[cropType] = {
                        crop_type: cropType,
                        total_yield: 0,
                        total_area: 0,
                        total_farms: 0,
                        barangays: new Set()
                    };
                }
                
                cropStats[cropType].total_yield += (crop.harvest_yield || 0);
                cropStats[cropType].total_area += (crop.area_planted || 0);
                cropStats[cropType].total_farms += 1;
                if (farm.farmers?.barangay) {
                    cropStats[cropType].barangays.add(farm.farmers.barangay);
                }
            });
        }
    });

        console.log('🔍 DEBUG: cropStats object before conversion:', cropStats);
    
    // Convert to array and return
    const result = Object.values(cropStats)
        .map(stat => ({
            ...stat,
            barangay_count: stat.barangays.size,
            average_yield: stat.total_area > 0 ? (stat.total_yield / stat.total_area) : 0,
            estimated_farm_gate: calculateFarmGatePrice(stat.crop_type, stat.total_yield),
            estimated_retail: calculateRetailPrice(stat.crop_type, stat.total_yield),
            demand_level: calculateDemandLevel(stat.total_yield),
            trend: calculateTrend(stat.crop_type)
        }))
        .sort((a, b) => b.total_yield - a.total_yield)
        .slice(0, 5);
    
    console.log('🔍 DEBUG: Final result array:', result);
    return result;
}

  // Update barangay crop data for the map with real data
  // Update barangay crop data for the map with real data
function updateBarangayCropData(farms) {
    const barangayData = {};
    
    farms.forEach(farm => {
        const barangay = farm.farmers?.barangay;
        if (!barangay) return;
        
        // Normalize to lowercase for consistent matching
        const normalizedBarangay = barangay.toLowerCase().trim();
        
        if (!barangayData[normalizedBarangay]) {
            barangayData[normalizedBarangay] = {
                crops: {},
                totalFarms: 0,
                totalArea: 0
            };
        }
        
        barangayData[normalizedBarangay].totalFarms++;
        barangayData[normalizedBarangay].totalArea += (farm.land_area || 0);
        
        if (farm.crops && farm.crops.length > 0) {
            farm.crops.forEach(crop => {
                const cropType = crop.crop_type || 'Unknown';
                // Only include crops from our defined list
                if (ALL_CROPS.includes(cropType)) {
                    barangayData[normalizedBarangay].crops[cropType] = 
                        (barangayData[normalizedBarangay].crops[cropType] || 0) + 1;
                }
            });
        }
    });
    
    window.realBarangayData = barangayData;
    console.log('🗺️ Updated barangay data with real farms:', barangayData);
}

  // Load market prices data
  async function loadMarketPricesData() {
    try {
        if (!supabase) {
            // If no supabase, calculate from crop statistics
            const cropStatsArray = cropStatistics ? Object.values(cropStatistics) : [];
            const calculatedPrices = calculateMarketPricesFromCrops(cropStatsArray);
            updateMarketPricesUI(calculatedPrices);
            updateMarketPricesChart(calculatedPrices);
            return;
        }

        const { data: prices, error } = await supabase
            .from('market_prices')
            .select('*')
            .order('recorded_at', { ascending: false })
            .limit(20);

        if (error || !prices || prices.length === 0) {
            // Calculate prices from crop data if no market prices available
            const cropStatsArray = cropStatistics ? Object.values(cropStatistics) : [];
            const calculatedPrices = calculateMarketPricesFromCrops(cropStatsArray);
            updateMarketPricesUI(calculatedPrices);
            updateMarketPricesChart(calculatedPrices);
        } else {
            // Filter prices to only include our defined crops
            const filteredPrices = prices.filter(price => 
                ALL_CROPS.includes(price.crop_type)
            );
            updateMarketPricesUI(filteredPrices);
            updateMarketPricesChart(filteredPrices);
        }
        
    } catch (error) {
        console.error('❌ Error loading market prices:', error);
        // Calculate prices from crop data as fallback
        const cropStatsArray = cropStatistics ? Object.values(cropStatistics) : [];
        const calculatedPrices = calculateMarketPricesFromCrops(cropStatsArray);
        updateMarketPricesUI(calculatedPrices);
        updateMarketPricesChart(calculatedPrices);
    }
}

 function calculateMarketPricesFromCrops(cropStats) {
    // Check if cropStats is valid and convert object to array if needed
    if (!cropStats) {
        return [];
    }
    
    // If cropStats is an object, convert it to array
    const cropsArray = Array.isArray(cropStats) ? cropStats : Object.values(cropStats);
    
    if (!cropsArray || cropsArray.length === 0) {
        return [];
    }
    
    return cropsArray.map(crop => ({
        crop_type: crop.crop_type,
        farm_gate_price: crop.estimated_farm_gate || calculateFarmGatePrice(crop.crop_type, crop.total_yield || 0),
        retail_price: crop.estimated_retail || calculateRetailPrice(crop.crop_type, crop.total_yield || 0),
        demand: crop.demand_level || calculateDemandLevel(crop.total_yield || 0),
        trend: crop.trend?.direction || calculateTrend(crop.crop_type).direction,
        trend_percentage: crop.trend?.percentage || calculateTrend(crop.crop_type).percentage,
        recorded_at: new Date().toISOString()
    }));
}

  // ============================================================================
  // UI UPDATE FUNCTIONS
  // ============================================================================

  // Update top crops UI with real data
  function updateTopCropsUI(cropsData) {
    const cropsContainer = document.getElementById('cropsContainer');
    if (!cropsContainer) return;
    
    cropsContainer.innerHTML = '';
    
    if (!cropsData || cropsData.length === 0) {
        cropsContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="ri-information-line text-4xl mb-2"></i>
                <p>No approved farm data available yet</p>
                <p class="text-sm">Farm data will appear here once approved by administrators</p>
            </div>
        `;
        return;
    }
    
    cropsData.forEach((crop, index) => {
        const yieldInTons = (crop.total_yield / 1000).toFixed(0);
        const yieldPerHectare = crop.average_yield ? (crop.average_yield / 1000).toFixed(1) : 0;
        
        const cropElement = `
            <div class="border border-gray-100 rounded-lg p-3 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                            <img src="${getCropImage(crop.crop_type)}" alt="${crop.crop_type}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h3 class="font-medium">${crop.crop_type}</h3>
                            <p class="text-xs text-gray-500">${yieldInTons} tons harvested</p>
                        </div>
                    </div>
                    <div class="flex items-center ${crop.trend.direction === 'up' ? 'text-green-600' : 'text-red-500'}">
                        <span class="text-sm font-medium">${crop.trend.direction === 'up' ? '+' : '-'}${crop.trend.percentage}%</span>
                        <i class="ri-arrow-${crop.trend.direction === 'up' ? 'up' : 'down'}-line ml-1"></i>
                    </div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2.5">
                    <div class="bg-primary h-2.5 rounded-full" style="width: ${calculateDemandWidth(crop.demand_level)}%"></div>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-xs text-gray-500">Demand</span>
                    <span class="text-xs font-medium">${crop.demand_level}</span>
                </div>
            </div>
        `;
        
        cropsContainer.innerHTML += cropElement;
    });
  }

  // Update market prices UI
  function updateMarketPricesUI(pricesData) {
    const tableBody = document.getElementById('priceTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (!pricesData || pricesData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                    <i class="ri-information-line text-2xl mb-2 block"></i>
                    No market data available
                </td>
            </tr>
        `;
        return;
    }
    
    pricesData.forEach(price => {
        const row = `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${price.crop_type}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-right">${price.farm_gate_price.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-right">${price.retail_price.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-right">
                    <span class="px-2 py-1 text-xs rounded-full ${getDemandColorClass(price.demand)}">${price.demand}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-right">
                    <span class="${price.trend === 'up' ? 'text-green-600' : price.trend === 'down' ? 'text-red-500' : 'text-gray-500'} text-sm flex items-center justify-end">
                        <span>${price.trend === 'up' ? '▲' : price.trend === 'down' ? '▼' : '●'} ${price.trend_percentage || 0}%</span>
                        <i class="ri-arrow-${price.trend === 'up' ? 'up' : price.trend === 'down' ? 'down' : 'right'}-line ml-1"></i>
                    </span>
                </td>
            </tr>
        `;
        
        tableBody.innerHTML += row;
    });
    
    if (pricesData.length > 0) {
        const latestDate = new Date(pricesData[0].recorded_at || new Date());
        const priceUpdateDateElement = document.getElementById('priceUpdateDate');
        if (priceUpdateDateElement) {
            priceUpdateDateElement.textContent = 
                latestDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
    }
  }

  // Update market prices chart
  function updateMarketPricesChart(pricesData) {
    const chartElement = document.getElementById('otherCropsChart');
    if (!chartElement) return;
    
    const topCrops = pricesData.slice(0, 6);
    const crops = topCrops.map(price => price.crop_type);
    const farmGatePrices = topCrops.map(price => price.farm_gate_price);
    const retailPrices = topCrops.map(price => price.retail_price);
    
    if (!window.priceChart) {
        window.priceChart = echarts.init(chartElement);
    }
    
    window.priceChart.setOption({
        tooltip: {
            trigger: 'axis',
            formatter: params => `
                <strong>${params[0].name}</strong><br/>
                Farm Gate: ₱${params[0].value}<br/>
                Retail: ₱${params[1].value}
            `
        },
        legend: { data: ['Farm Gate Price', 'Retail Price'], bottom: 0 },
        xAxis: {
            type: 'category',
            data: crops,
            axisLabel: { interval: 0, rotate: crops.length > 4 ? 45 : 0 }
        },
        yAxis: { type: 'value', name: 'Price (₱)' },
        series: [
            {
                name: 'Farm Gate Price',
                type: 'bar',
                data: farmGatePrices,
                itemStyle: { color: '#2E7D32' }
            },
            {
                name: 'Retail Price',
                type: 'bar',
                data: retailPrices,
                itemStyle: { color: '#81C784' }
            }
        ]
    });
  }

  // ============================================================================
  // CALCULATION FUNCTIONS
  // ============================================================================

  function calculateDemandLevel(yieldAmount) {
    if (yieldAmount < 5000000) return 'Very High';
    if (yieldAmount < 2500000) return 'High';
    if (yieldAmount < 1000000) return 'Medium';
    if (yieldAmount < 500000) return 'Low';
    return 'Very Low';
  }

  function calculateDemandWidth(demandLevel) {
    switch(demandLevel) {
        case 'Very High': return 95;
        case 'High': return 80;
        case 'Medium': return 65;
        case 'Low': return 40;
        case 'Very Low': return 25;
        default: return 50;
    }
  }

  function calculateFarmGatePrice(cropType, yieldAmount) {
    const basePrices = {
        'Banana': 25, 'Durian': 80, 'Coconut': 18, 'Mango': 45, 'Pineapple': 35,
        'Papaya': 20, 'Watermelon': 15, 'Rice': 32, 'Corn': 15, 'Cabbage': 18,
        'Petchay': 12, 'Kangkong': 10, 'Spinach': 15, 'Tomato': 25, 'Eggplant': 20,
        'Bell Pepper': 30, 'Ampalaya': 18, 'Sayote': 12, 'Squash': 15, 'Okra': 22,
        'Baguio Beans': 28, 'String Beans': 20, 'Mung Bean': 25, 'Peanut': 35,
        'Carrots': 22, 'Radish': 15, 'Sweet Potato': 18, 'Cassava': 12, 'Ginger': 40,
        'Garlic': 60, 'Onion': 35, 'Coffee': 120, 'Cacao': 90, 'Abaca': 25,
        'Rubber': 30, 'Sugarcane': 15
    };
    
    const basePrice = basePrices[cropType] || 20;
    const supplyFactor = Math.max(0.5, Math.min(2, 1000000 / (yieldAmount || 1000000)));
    
    return basePrice * supplyFactor;
  }

  function calculateRetailPrice(cropType, yieldAmount) {
    const farmGate = calculateFarmGatePrice(cropType, yieldAmount);
    return farmGate * (1.5 + Math.random() * 0.5);
  }

  function calculateTrend(cropType) {
    const trends = ['up', 'down', 'stable'];
    const direction = trends[Math.floor(Math.random() * trends.length)];
    const percentage = (Math.random() * 15 + 1).toFixed(0);
    
    return { direction, percentage: parseInt(percentage) };
  }

  function getDemandColorClass(demandLevel) {
    switch(demandLevel) {
        case 'Very High': return 'bg-red-100 text-red-800';
        case 'High': return 'bg-orange-100 text-orange-800';
        case 'Medium': return 'bg-blue-100 text-blue-800';
        case 'Low': return 'bg-green-100 text-green-800';
        case 'Very Low': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
  }

  function getCropImage(cropType) {
    // Convert crop type to lowercase for image lookup
    const cropKey = cropType.toLowerCase();
    
    // Try exact match first
    if (CROP_IMAGES[cropKey]) {
        return CROP_IMAGES[cropKey];
    }
    
    // Try partial matches for compound names
    for (const [key, image] of Object.entries(CROP_IMAGES)) {
        if (cropKey.includes(key) || key.includes(cropKey)) {
            return image;
        }
    }
    
    // Default image
    return 'https://cdn-icons-png.flaticon.com/512/17866/17866804.png';
  }

  // ============================================================================
  // MENU AND NAVIGATION
  // ============================================================================

  const menuButton = document.getElementById('menuButton');
  const menuContent = document.getElementById('menuContent');

  if (menuButton && menuContent) {
    menuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      menuButton.classList.toggle('active');
      menuContent.classList.toggle('show');
    });

    document.addEventListener('click', function() {
      menuButton.classList.remove('active');
      menuContent.classList.remove('show');
    });

    menuContent.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  const menuItems = document.querySelectorAll('.menu-item[data-section]');
  const sections = document.querySelectorAll('.section');

  menuItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      menuItems.forEach(btn => btn.classList.remove('active'));
      sections.forEach(section => section.classList.remove('active'));
      
      this.classList.add('active');
      const sectionId = this.getAttribute('data-section');
      const sectionElement = document.getElementById(sectionId);
      if (sectionElement) {
        sectionElement.classList.add('active');
      }
      
      if (menuButton && menuContent) {
        menuButton.classList.remove('active');
        menuContent.classList.remove('show');
      }
      
      if (sectionId === 'map-section' && window.pieChart) {
        setTimeout(() => {
          window.pieChart.resize();
        }, 100);
      } else if (sectionId === 'other-section' && window.priceChart) {
        setTimeout(() => {
          window.priceChart.resize();
        }, 100);
      }
    });
  });

  window.addEventListener('resize', function() {
    if (window.pieChart) window.pieChart.resize();
    if (window.priceChart) window.priceChart.resize();
  });

  // Update date
  const priceUpdateDateElement = document.getElementById('priceUpdateDate');
  if (priceUpdateDateElement) {
    priceUpdateDateElement.textContent = 
      new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  }

  // Login button
  const loginButton = document.getElementById('loginBtn');
  if (loginButton) {
    loginButton.addEventListener('click', function(e) {
      e.preventDefault();
      window.location.href = "jey.html";
    });
  }

  // ============================================================================
  // AGRICULTURAL MAP SECTION
  // ============================================================================

  function initAgriculturalMap() {
    const mapElement = document.getElementById('maragusanMap');
    if (!mapElement) return;
    
    // Initialize map
    const map = L.map('maragusanMap', {
      preferCanvas: true,
      zoomControl: false
    }).setView([7.3167, 126.1167], 12);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
      minZoom: 10
    }).addTo(map);

    // Initialize pie chart
    const pieChartElement = document.getElementById('cropPieChart');
    if (pieChartElement) {
      window.pieChart = echarts.init(pieChartElement);
    }

    // Corrected GeoJSON data structure
    const maragusanGeoJSON = {
      "type": "FeatureCollection",
      "features": [
         {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.11824745900003,7.281522877000042],[126.10937396300005,7.298633386000062],[126.08782097000004,7.297237534000033],[126.03789877200006,7.28903752900004],[126.0383924160001,7.273797866000054],[126.0989881480001,7.266595504000064],[126.10484952700006,7.264421566000065],[126.109395188,7.27940951800002],[126.11824745900003,7.281522877000042]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205001,"adm4_en":"Bagong Silang","geo_level":"Bgy","len_crs":21979,"area_crs":22516670,"len_km":21,"area_km2":22},"id":1108205001},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22310075400003,7.312405174000048],[126.17610831300011,7.309606481000059],[126.15565110700004,7.309669041000063],[126.14337257200008,7.313982807000057],[126.14010245600004,7.302028542000075],[126.1339534330001,7.287911773000074],[126.13430811000002,7.270457247000023],[126.14112077200002,7.25723151300002],[126.15932622300011,7.257347224000057],[126.22821264900006,7.271529252000049],[126.22644868900011,7.294101517000059],[126.22310075400003,7.312405174000048]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205002,"adm4_en":"Mapawa","geo_level":"Bgy","len_crs":30384,"area_crs":52842364,"len_km":30,"area_km2":52},"id":1108205002},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.14043155800005,7.341157109000051],[126.12554958500006,7.345077915000048],[126.10165720900011,7.358041175000039],[126.09482120800011,7.352218626000023],[126.08488086700005,7.34981484200006],[126.08547518700004,7.337677729000061],[126.09405015900005,7.335846838000068],[126.10248811100007,7.327086459000039],[126.1121700870001,7.32744540300007],[126.10742447500003,7.31469677900003],[126.11768512600008,7.309067041000046],[126.14010245600004,7.302028542000075],[126.14337257200008,7.313982807000057],[126.1444673950001,7.326425437000069],[126.14043155800005,7.341157109000051]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205003,"adm4_en":"Poblacion","geo_level":"Bgy","len_crs":22000,"area_crs":22237141,"len_km":22,"area_km2":22},"id":1108205003},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22262782600002,7.33534847900006],[126.22268892800004,7.368079059000026],[126.16854951900007,7.356401403000064],[126.14506605300005,7.352267390000065],[126.14043155800005,7.341157109000051],[126.1444673950001,7.326425437000069],[126.16757922300008,7.323747433000051],[126.22310078500003,7.322288443000047],[126.22262782600002,7.33534847900006]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205004,"adm4_en":"New Albay","geo_level":"Bgy","len_crs":25722,"area_crs":35072772,"len_km":25,"area_km2":35},"id":1108205004},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22082002900004,7.399019778000024],[126.16708201000004,7.426584637000076],[126.16096043100003,7.427399020000053],[126.13452285600009,7.397324797000068],[126.135829209,7.386209988000076],[126.13894616100004,7.376047370000034],[126.14441351700009,7.373392559000022],[126.15718683900003,7.375483396000049],[126.17793506700004,7.375619640000028],[126.22182696000006,7.377852339000074],[126.22082002900004,7.399019778000024]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205005,"adm4_en":"Tupas","geo_level":"Bgy","len_crs":26069,"area_crs":39689629,"len_km":26,"area_km2":39},"id":1108205005},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22821264900006,7.271529252000049],[126.250561091,7.27516314500002],[126.27256536100003,7.282416777000037],[126.2962930000001,7.2861],[126.29616660300007,7.32542098600004],[126.29535864700006,7.338889993000068],[126.26664464600005,7.337162311000043],[126.22723381400012,7.33676820200003],[126.22262782600002,7.33534847900006],[126.22310078500003,7.322288443000047],[126.22310075400003,7.312405174000048],[126.22644868900011,7.294101517000059],[126.22821264900006,7.271529252000049]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205006,"adm4_en":"Bahi","geo_level":"Bgy","len_crs":28747,"area_crs":51200537,"len_km":28,"area_km2":51},"id":1108205006},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.135829209,7.386209988000076],[126.13122269100008,7.378255329000069],[126.12515833900011,7.377806118000025],[126.11192997800005,7.383965181000065],[126.10816756300005,7.389225968000062],[126.10583662700003,7.383499950000044],[126.1096902260001,7.370219250000048],[126.13760124900013,7.368209591000039],[126.14164021800002,7.352764832000049],[126.1444461200001,7.352964814000072],[126.14638341000013,7.361798854000028],[126.14441351700009,7.373392559000022],[126.13894616100004,7.376047370000034],[126.135829209,7.386209988000076]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205007,"adm4_en":"Cambagang","geo_level":"Bgy","len_crs":16258,"area_crs":6137153,"len_km":16,"area_km2":6},"id":1108205007},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22310078500003,7.322288443000047],[126.16757922300008,7.323747433000051],[126.1444673950001,7.326425437000069],[126.14337257200008,7.313982807000057],[126.15565110700004,7.309669041000063],[126.17610831300011,7.309606481000059],[126.22310075400003,7.312405174000048],[126.22310078500003,7.322288443000047]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205008,"adm4_en":"Coronobe","geo_level":"Bgy","len_crs":20242,"area_crs":12411675,"len_km":20,"area_km2":12},"id":1108205008},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.16096043100003,7.427399020000053],[126.13000466200005,7.433196931000055],[126.12508982300007,7.43115051600006],[126.12185702800004,7.41833504300007],[126.12054731300009,7.407251482000049],[126.11853328300002,7.395690342000022],[126.135829209,7.386209988000076],[126.13452285600009,7.397324797000068],[126.16096043100003,7.427399020000053]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205009,"adm4_en":"Katipunan","geo_level":"Bgy","len_crs":16165,"area_crs":12348212,"len_km":16,"area_km2":12},"id":1108205009},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22268892800004,7.368079059000026],[126.22260495100011,7.375632501000043],[126.19500201500013,7.37298778200005],[126.1514205750001,7.36174718700005],[126.14638341000013,7.361798854000028],[126.1444461200001,7.352964814000072],[126.14506605300005,7.352267390000065],[126.16854951900007,7.356401403000064],[126.22268892800004,7.368079059000026]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205010,"adm4_en":"Lahi","geo_level":"Bgy","len_crs":19560,"area_crs":9262481,"len_km":19,"area_km2":9},"id":1108205010},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.29535864700006,7.338889993000068],[126.29403068900001,7.351496064000058],[126.29353460300003,7.384353847000057],[126.29129779600008,7.383675694000032],[126.22082002900004,7.399019778000024],[126.22182696000006,7.377852339000074],[126.22260495100011,7.375632501000043],[126.22268892800004,7.368079059000026],[126.22262782600002,7.33534847900006],[126.22723381400012,7.33676820200003],[126.26664464600005,7.337162311000043],[126.29535864700006,7.338889993000068]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205011,"adm4_en":"Langgawisan","geo_level":"Bgy","len_crs":28436,"area_crs":47145761,"len_km":28,"area_km2":47},"id":1108205011},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.09424107600012,7.311540799000056],[126.08792179600006,7.321209298000043],[126.03859226000009,7.322863967000046],[126.03849251000007,7.306879538000031],[126.08417910800006,7.309157844000024],[126.09424107600012,7.311540799000056]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205012,"adm4_en":"Mabugnao","geo_level":"Bgy","len_crs":14854,"area_crs":8983912,"len_km":14,"area_km2":8},"id":1108205012},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.08488086700005,7.34981484200006],[126.0539273190001,7.354620575000069],[126.04381830500006,7.341662563000056],[126.03859226000009,7.322863967000046],[126.08792179600006,7.321209298000043],[126.09424107600012,7.311540799000056],[126.10742447500003,7.31469677900003],[126.1121700870001,7.32744540300007],[126.10248811100007,7.327086459000039],[126.09405015900005,7.335846838000068],[126.08547518700004,7.337677729000061],[126.08488086700005,7.34981484200006]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205013,"adm4_en":"Magcagong","geo_level":"Bgy","len_crs":22235,"area_crs":20294767,"len_km":22,"area_km2":20},"id":1108205013},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.10165720900011,7.358041175000039],[126.092293863,7.356104531000029],[126.06132032900005,7.363822872000071],[126.0539273190001,7.354620575000069],[126.08488086700005,7.34981484200006],[126.09482120800011,7.352218626000023],[126.10165720900011,7.358041175000039]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205014,"adm4_en":"Mahayahay","geo_level":"Bgy","len_crs":11519,"area_crs":4267761,"len_km":11,"area_km2":4},"id":1108205014},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.14010245600004,7.302028542000075],[126.11768512600008,7.309067041000046],[126.11432544400009,7.298624786000061],[126.10937396300005,7.298633386000062],[126.11824745900003,7.281522877000042],[126.12325592200011,7.282834666000042],[126.1339534330001,7.287911773000074],[126.14010245600004,7.302028542000075]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205015,"adm4_en":"Mauswagon","geo_level":"Bgy","len_crs":10345,"area_crs":6043576,"len_km":10,"area_km2":6},"id":1108205015},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.11768512600008,7.309067041000046],[126.10742447500003,7.31469677900003],[126.09424107600012,7.311540799000056],[126.08417910800006,7.309157844000024],[126.03849251000007,7.306879538000031],[126.03789877200006,7.28903752900004],[126.08782097000004,7.297237534000033],[126.10937396300005,7.298633386000062],[126.11432544400009,7.298624786000061],[126.11768512600008,7.309067041000046]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205016,"adm4_en":"New Katipunan","geo_level":"Bgy","len_crs":20724,"area_crs":14059401,"len_km":20,"area_km2":14},"id":1108205016},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.135829209,7.386209988000076],[126.11853328300002,7.395690342000022],[126.10816756300005,7.389225968000062],[126.11192997800005,7.383965181000065],[126.12515833900011,7.377806118000025],[126.13122269100008,7.378255329000069],[126.135829209,7.386209988000076]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205017,"adm4_en":"New Manay","geo_level":"Bgy","len_crs":7560,"area_crs":3520041,"len_km":7,"area_km2":3},"id":1108205017},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.11967900900005,7.258708042000024],[126.12325592200011,7.282834666000042],[126.11824745900003,7.281522877000042],[126.109395188,7.27940951800002],[126.10484952700006,7.264421566000065],[126.11967900900005,7.258708042000024]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205018,"adm4_en":"New Panay","geo_level":"Bgy","len_crs":7769,"area_crs":3470291,"len_km":7,"area_km2":3},"id":1108205018},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.12054731300009,7.407251482000049],[126.09698914500005,7.403054589000019],[126.09122710500004,7.403717846000061],[126.0751044640001,7.412728439000034],[126.071978929,7.382533989000025],[126.10583662700003,7.383499950000044],[126.10816756300005,7.389225968000062],[126.11853328300002,7.395690342000022],[126.12054731300009,7.407251482000049]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205019,"adm4_en":"Paloc","geo_level":"Bgy","len_crs":15781,"area_crs":11664558,"len_km":15,"area_km2":11},"id":1108205019},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.1444461200001,7.352964814000072],[126.14164021800002,7.352764832000049],[126.13760124900013,7.368209591000039],[126.1096902260001,7.370219250000048],[126.10165720900011,7.358041175000039],[126.12554958500006,7.345077915000048],[126.14043155800005,7.341157109000051],[126.14506605300005,7.352267390000065],[126.1444461200001,7.352964814000072]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205020,"adm4_en":"Pamintaran","geo_level":"Bgy","len_crs":13410,"area_crs":9869184,"len_km":13,"area_km2":9},"id":1108205020},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.1096902260001,7.370219250000048],[126.10583662700003,7.383499950000044],[126.071978929,7.382533989000025],[126.07129589500005,7.377028716000039],[126.06132032900005,7.363822872000071],[126.092293863,7.356104531000029],[126.10165720900011,7.358041175000039],[126.1096902260001,7.370219250000048]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205021,"adm4_en":"Parasanon","geo_level":"Bgy","len_crs":14371,"area_crs":11347421,"len_km":14,"area_km2":11},"id":1108205021},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.22260495100011,7.375632501000043],[126.22182696000006,7.377852339000074],[126.17793506700004,7.375619640000028],[126.15718683900003,7.375483396000049],[126.14441351700009,7.373392559000022],[126.14638341000013,7.361798854000028],[126.1514205750001,7.36174718700005],[126.19500201500013,7.37298778200005],[126.22260495100011,7.375632501000043]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205022,"adm4_en":"Talian","geo_level":"Bgy","len_crs":19080,"area_crs":6233962,"len_km":19,"area_km2":6},"id":1108205022},
      {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[126.12185702800004,7.41833504300007],[126.1026,7.426277],[126.07713114300007,7.432533883000075],[126.0751044640001,7.412728439000034],[126.09122710500004,7.403717846000061],[126.09698914500005,7.403054589000019],[126.12054731300009,7.407251482000049],[126.12185702800004,7.41833504300007]]]},"properties":{"adm1_psgc":1100000000,"adm2_psgc":1108200000,"adm3_psgc":1108205000,"adm4_psgc":1108205023,"adm4_en":"Tandik","geo_level":"Bgy","len_crs":13996,"area_crs":11241789,"len_km":13,"area_km2":11},"id":1108205023},
    ]
    };


    // Store the GeoJSON layer reference
    let geojsonLayer = null;
    
    // Style functions
    function styleBarangay(feature) {
      return {
        fillColor: '#2E7D32',
        weight: 2,
        opacity: 1,
        color: '#2E7D32',
        dashArray: '3',
        fillOpacity: 0.5
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 3,
        color: '#FF5722',
        dashArray: '',
        fillOpacity: 0.7
      });
      layer.bringToFront();
    }

    function resetHighlight(e) {
      if (geojsonLayer) geojsonLayer.resetStyle(e.target);
    }

    function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
            showBarangay(feature);
            const selector = document.getElementById('barangaySelector');
            if (selector) selector.value = feature.properties.adm4_en.toLowerCase(); // ← CHANGED
        }
    });
}

    // Function to show a single barangay
    function showBarangay(feature) {
      // Clear any existing layers
      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }
      
      // Create a feature collection with just this barangay
      const singleFeature = {
        type: "FeatureCollection",
        features: [feature]
      };
      
      // Add the single barangay to the map
      geojsonLayer = L.geoJson(singleFeature, {
        style: styleBarangay,
        onEachFeature: onEachFeature
      }).addTo(map);
      
      // Zoom to the barangay
      map.fitBounds(geojsonLayer.getBounds());
      
      // Show crop data
      showCropData(feature.properties.adm4_en);
      
      // Open the slide panel
      openSlidePanel();
    }

    // Function to show REAL crop data for a barangay
    // Function to show REAL crop data for a barangay
// Function to show REAL crop data for a barangay
function showCropData(barangayName) {
    // Normalize the barangay name to lowercase for matching with database
    const normalizedBarangayName = normalizeBarangayNameForData(barangayName);
    
    // Use real data from approved farms
    const realData = window.realBarangayData?.[normalizedBarangayName];
    
    console.log('📊 DEBUG showCropData: Barangay:', barangayName, 'Normalized:', normalizedBarangayName);
    console.log('📊 DEBUG showCropData: realData available?', !!realData);
    console.log('📊 DEBUG showCropData: realData content:', realData);
    
    const data = realData ? convertRealDataToPieData(realData) : getFallbackBarangayData(barangayName);
    
    console.log('📊 DEBUG showCropData: Final pie chart data:', data);
    
    // Update title
    const barangayTitleElement = document.getElementById('barangayTitle');
    if (barangayTitleElement) {
        barangayTitleElement.textContent = barangayName;
    }
    
    // Update statistics with REAL data
    if (realData) {
        document.getElementById('barangayArea').textContent = Math.round(realData.totalArea) + ' ha';
        document.getElementById('barangayPopulation').textContent = realData.totalFarms + ' farms';
    } else {
        document.getElementById('barangayArea').textContent = '--';
        document.getElementById('barangayPopulation').textContent = '--';
    }
    
    // Update pie chart
    if (window.pieChart) {
        const chartData = data.map(item => ({
            value: item.percentage,
            name: item.crop,
            itemStyle: { color: item.color }
        }));
        
        console.log('📊 DEBUG showCropData: Chart data sent to pie chart:', chartData);
        
        window.pieChart.setOption({
            tooltip: { trigger: 'item', formatter: '{b}: {c}%' },
            series: [{
                name: 'Crop Distribution',
                type: 'pie',
                radius: ['45%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                label: { show: false, position: 'center' },
                emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } },
                labelLine: { show: false },
                data: chartData
            }]
        });
    }
    
    // Update legend
    const legendElement = document.getElementById('cropLegend');
    if (legendElement) {
        const legendHtml = data.map(item => `
            <div class="crop-legend-item">
                <span class="crop-legend-color" style="background-color:${item.color}"></span>
                <span>${item.crop} (${item.percentage}%)</span>
            </div>
        `).join('');
        legendElement.innerHTML = legendHtml;
    }
}

    // Convert real barangay data to pie chart format
   function convertRealDataToPieData(realBarangayData) {
      // ADD DEBUG LINES:
      console.log('📊 DEBUG convertRealDataToPieData: Input:', realBarangayData);
      
      const crops = realBarangayData.crops;
      const total = Object.values(crops).reduce((sum, count) => sum + count, 0);
      
      // ADD DEBUG LINES:
      console.log('📊 DEBUG convertRealDataToPieData: Total crop count:', total);
      console.log('📊 DEBUG convertRealDataToPieData: Crops object:', crops);
      
      if (total === 0) {
        console.log('📊 DEBUG convertRealDataToPieData: No crop data, using fallback');
        return [{ crop: "No Data", percentage: 100, color: '#9E9E9E' }];
      }
      
      const result = Object.entries(crops)
        .map(([crop, count]) => ({
          crop: crop,
          percentage: Math.round((count / total) * 100),
          color: getCropColor(crop)
        }))
        .sort((a, b) => b.percentage - a.percentage)
        .slice(0, 6);
      
      // ADD DEBUG LINE:
      console.log('📊 DEBUG convertRealDataToPieData: Final result:', result);
      return result;
    }

   function getCropColor(cropType) {
    const colorMap = {
        'banana': '#2E7D32', 'durian': '#4CAF50', 'coconut': '#795548', 'mango': '#FF9800',
        'pineapple': '#FFC107', 'papaya': '#FF5722', 'watermelon': '#F44336', 'rice': '#FFEB3B',
        'corn': '#FF9800', 'cabbage': '#8BC34A', 'pechay': '#689F38', 'kangkong': '#4CAF50',
        'spinach': '#388E3C', 'tomato': '#F44336', 'eggplant': '#9C27B0', 'bell pepper': '#FF5722',
        'ampalaya': '#795548', 'sayote': '#8BC34A', 'squash': '#FF9800', 'okra': '#4CAF50',
        'baguio beans': '#689F38', 'string_beans': '#8BC34A', 'mung bean': '#CDDC39', 'peanut': '#795548',
        'carrots': '#FF9800', 'radish': '#F44336', 'sweet potato': '#FF5722', 'cassava': '#795548',
        'ginger': '#FF9800', 'garlic': '#9E9E9E', 'onion': '#9C27B0', 'coffee': '#5D4037',
        'cacao': '#6D4C41', 'abaca': '#795548', 'rubber': '#5D4037', 'sugarcane': '#795548'
    };
    
    return colorMap[cropType] || '#' + Math.floor(Math.random()*16777215).toString(16);
}

    function getFallbackBarangayData(barangayName) {
      return [
        { crop: "No Farm Data", percentage: 100, color: '#9E9E9E' }
      ];
    }

    // Slide panel functionality
    // Slide panel functionality
const slidePanel = document.getElementById('slidePanel');
const slidePanelHandle = document.getElementById('slidePanelHandle');
let isPanelOpen = false;

function openSlidePanel() {
    if (slidePanel) slidePanel.classList.add('open');
    isPanelOpen = true;
}

function closeSlidePanel() {
    if (slidePanel) slidePanel.classList.remove('open');
    isPanelOpen = false;
}

function toggleSlidePanel() {
    if (isPanelOpen) {
        closeSlidePanel();
    } else {
        openSlidePanel();
    }
}

// Make the entire header area clickable
const barangayTitle = document.getElementById('barangayTitle');
if (barangayTitle) {
    barangayTitle.style.cursor = 'pointer';
    barangayTitle.addEventListener('click', toggleSlidePanel);
}

// Handle click
if (slidePanelHandle) {
    slidePanelHandle.addEventListener('click', toggleSlidePanel);
}

// Enhanced touch handling
if (slidePanel) {
    let touchStartY = 0;
    
    slidePanel.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    });
    
    slidePanel.addEventListener('touchend', function(e) {
        const touchEndY = e.changedTouches[0].clientY;
        const swipeDistance = touchEndY - touchStartY;
        
        if (Math.abs(swipeDistance) > 20) { // Swipe threshold
            if (swipeDistance > 0 && isPanelOpen) {
                closeSlidePanel(); // Swipe down
            } else if (swipeDistance < 0 && !isPanelOpen) {
                openSlidePanel(); // Swipe up
            }
        }
    });
}

    // Populate barangay selector
    const selector = document.getElementById('barangaySelector');
    if (selector) {
     maragusanGeoJSON.features.forEach(feature => {
    const option = document.createElement('option');
    option.value = feature.properties.adm4_en.toLowerCase(); // ← CHANGED
    option.textContent = feature.properties.adm4_en;
    selector.appendChild(option);
});

      // Barangay selector change handler
      selector.addEventListener('change', function() {
        const selectedBarangay = this.value;
        if (selectedBarangay) {
          const selectedFeature = maragusanGeoJSON.features.find(
            f => f.properties.adm4_en === selectedBarangay
          );
          
          if (selectedFeature) {
            showBarangay(selectedFeature);
          }
        }
      });
    }

    // Reset map button
    const resetMapButton = document.getElementById('resetMap');
    if (resetMapButton) {
      resetMapButton.addEventListener('click', function() {
        if (geojsonLayer) {
          map.removeLayer(geojsonLayer);
          geojsonLayer = null;
        }
        const selector = document.getElementById('barangaySelector');
        if (selector) selector.value = '';
        closeSlidePanel();
        map.setView([7.3167, 126.1167], 12);
      });
    }
  }

  // ============================================================================
  // PUBLIC API FOR EXTERNAL UPDATES
  // ============================================================================

  // Call this when new farm data is submitted and approved
  window.refreshFarmData = async function() {
    console.log('🔄 Manually refreshing farm data...');
    await loadApprovedFarmsData();
  };

  // Call this when new market prices are submitted
  window.refreshMarketData = async function() {
    console.log('🔄 Manually refreshing market data...');
    await loadMarketPricesData();
  };

  // Test function to show current data
  window.showCurrentData = function() {
    console.log('📊 Current approved farms:', approvedFarms.length);
    console.log('💰 Current market prices:', marketPrices.length);
    console.log('🌱 Current crop statistics:', cropStatistics.length);
    return {
      farms: approvedFarms,
      prices: marketPrices,
      crops: cropStatistics
    };
  };
</script>
</body>
</html>

